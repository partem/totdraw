<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>TotDraw</title>

<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-6L1KQZT5MC"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-6L1KQZT5MC');
</script>

<style>
    body, html { margin: 0; padding: 0; overflow: hidden; }
    canvas { width: 100%; height: 80%; display: block; }
    #controls { 
        width: 100%; 
        height: 20%; 
        text-align: center; 
    }
    .control-button { 
        font-size: 30px;  
        padding: 10px;
        margin: 10px;
        cursor: pointer;
    }
    .hidden {
        display: none;
    }
    .modal {
        display: none; 
        position: fixed; 
        z-index: 1; 
        left: 0;
        top: 0;
        width: 100%; 
        height: 100%; 
        overflow: auto; 
        background-color: rgba(0,0,0,0.4); 
    }
    .modal-content {
        position: relative;
        background-color: #fefefe;
        margin: 15% auto; 
        padding: 20px;
        border: 1px solid #888;
        width: 80%; 
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
        gap: 10px;
    }
    .close {
        position: absolute;
        top: 10px;
        right: 10px;
        color: #aaa;
        font-size: 28px;
        font-weight: bold;
    }
    .close:hover,
    .close:focus {
        color: black;
        text-decoration: none;
        cursor: pointer;
    }
    .small-image {
        max-width: 100px;
        max-height: 100px;
    }
    .control-button.pressed {
        background-color: #717070;
    }
</style>
</head>
<body>
<canvas id="drawingCanvas"></canvas>
<div id="controls">
    <button id="clearButton" class="control-button">üóëÔ∏è</button>
    <button id="eraserButton" class="control-button">üßΩ</button>
    <input type="file" id="uploadButton" class="hidden" accept="image/*">
    <label for="uploadButton" class="control-button upload-button">üñºÔ∏è</label>
    <input type="color" id="colorPicker" class="control-button">
    <button id="animalSearchButton" class="control-button">ü¶Å</button>
    <button id="dinosaurButton" class="control-button">ü¶ñ</button>
    <button id="carButton" class="control-button">üöó</button>
    <button id="birdButton" class="control-button">ü¶ú</button>
    <button id="insectButton" class="control-button">üêû</button>
</div>
<div id="myModal" class="modal">
  <span class="close">&times;</span>
  <div class="modal-content">
  </div>
</div>
<script>
    document.addEventListener('dblclick', function(event) {
        event.preventDefault();
    });
    const canvas = document.getElementById('drawingCanvas');
    const ctx = canvas.getContext('2d');
    let backgroundImage = null;
    let currentColor = '#000000'; // Default color
    let isEraserActive = false;

    // Set up the canvas size
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight * 0.8; // Adjusted for control buttons height

    let isDrawing = false;

    function startDrawing(e) {
        if (e.touches && e.touches[0].touchType === 'stylus') {
            // Handle Apple Pencil touch
        } else {
            // Handle finger touch
        }
        isDrawing = true;
        draw(e);
        e.preventDefault(); // Prevent default behavior
    }

    function draw(e) {
        if (!isDrawing) return;
        ctx.lineWidth = 5; // Line width
        ctx.lineCap = 'round'; // Line style
        ctx.strokeStyle = currentColor; // Use the selected color

        const x = e.clientX || e.touches[0].clientX;
        const y = e.clientY || e.touches[0].clientY - canvas.offsetTop;

        ctx.lineTo(x, y); // Draw line
        ctx.stroke();
        ctx.beginPath(); // Begin new path
        ctx.moveTo(x, y);
    }

    function stopDrawing() {
        isDrawing = false;
        ctx.beginPath(); // Begin a new path to start a new line
    }

    // Clear the canvas and background
    function clearCanvas() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        backgroundImage = null; // Clear the reference to the background image
    }

    // Upload and draw background image
    function uploadAndDrawBackground(e) {
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(evt) {
                const img = new Image();
                img.onload = function() {
                    backgroundImage = img;
                    drawBackgroundImage(); // Use the drawBackgroundImage function
                }
                img.src = evt.target.result;
            };
            reader.readAsDataURL(file);
        }
        e.target.value = '';
    }

    function drawBackgroundImage() {
        if (backgroundImage) {
            const ratio = Math.min(canvas.width / backgroundImage.width, canvas.height / backgroundImage.height);
            const newWidth = backgroundImage.width * ratio;
            const newHeight = backgroundImage.height * ratio;
            const offsetX = (canvas.width - newWidth) / 2;
            const offsetY = (canvas.height - newHeight) / 2;
            ctx.drawImage(backgroundImage, offsetX, offsetY, newWidth, newHeight);
        }
    }

    // Event listeners for touch and mouse
    canvas.addEventListener('touchstart', startDrawing);
    canvas.addEventListener('touchmove', draw);
    canvas.addEventListener('touchend', stopDrawing);
    canvas.addEventListener('touchcancel', stopDrawing);
    canvas.addEventListener('mousedown', startDrawing);
    canvas.addEventListener('mousemove', draw);
    canvas.addEventListener('mouseup', stopDrawing);
    canvas.addEventListener('mouseleave', stopDrawing);

    // Event listener for the clear button
    document.getElementById('clearButton').addEventListener('click', clearCanvas);

    // Event listener for the upload button
    document.getElementById('uploadButton').addEventListener('change', uploadAndDrawBackground);

    // Color picker event listener
    document.getElementById('colorPicker').addEventListener('change', function(e) {
        currentColor = e.target.value;
        isEraserActive = false; // Disable eraser mode
        document.getElementById('eraserButton').classList.remove('pressed'); // Remove pressed state
    });

    // Prevent default scrolling on touch events
    document.addEventListener('touchmove', function(e) {
        e.preventDefault();
    }, { passive: false });

    // Suppress right-click menu
    document.addEventListener('contextmenu', function(e) {
        e.preventDefault();
    });

    // Suppress long press on everything except the canvas
    let touchStartTimer;
    document.addEventListener('touchstart', function(e) {
        if (e.target !== canvas) {
            touchStartTimer = setTimeout(function() {
                e.preventDefault();
            }, 1000); // 1000ms = 1 second
        }
    }, { passive: false });

    document.addEventListener('touchend', function() {
        clearTimeout(touchStartTimer);
    });

    // Modal functionality
    var modal = document.getElementById("myModal");
    var btn = document.getElementById("animalSearchButton");
    var dinosaurBtn = document.getElementById("dinosaurButton");
    var carBtn = document.getElementById("carButton");
    var birdBtn = document.getElementById("birdButton");
    var insectBtn = document.getElementById("insectButton");
    var span = document.getElementsByClassName("close")[0];

    let animalPage = 1;
    let dinosaurPage = 1;
    let carPage = 1;
    let birdPage = 1;
    let insectPage = 1;

    function fetchImages(searchTerm, page) {
      modal.style.display = "block";
      const modalContent = document.querySelector('.modal-content');
      modalContent.innerHTML = ''; // Clear existing images

      // Unsplash API request
      fetch(`https://api.unsplash.com/search/photos?page=${page}&query=${searchTerm}&per_page=10`, {
        headers: {
          'Authorization': 'Client-ID 0eGlvOmkRrJhaSTAQHnxWm_q4ktsxrzruuBADWYBbbo'
        }
      })
      .then(response => response.json())
      .then(data => {
        const modalContent = document.querySelector('.modal-content');
        data.results.forEach(photo => {
          const img = document.createElement('img');
          img.src = photo.urls.thumb;
          img.classList.add('small-image'); // Add the small-image class
          img.addEventListener('click', function() {
            const newImg = new Image();
            newImg.onload = function() {
                clearCanvas(); // Clear the previous image
                backgroundImage = newImg;
                drawBackgroundImage();
                modal.style.display = "none";
            }
            newImg.src = photo.urls.regular;
          });
          modalContent.appendChild(img);
        });
      })
      .catch(error => console.error(error));
    }

    btn.onclick = function() {
      fetchImages('animals', animalPage);
      animalPage++;
    }

    dinosaurBtn.onclick = function() {
      fetchImages('dinosaurs', dinosaurPage);
      dinosaurPage++;
    }

    carBtn.onclick = function() {
      fetchImages('cars', carPage);
      carPage++;
    }

    birdBtn.onclick = function() {
      fetchImages('birds', birdPage);
      birdPage++;
    }

    insectBtn.onclick = function() {
      fetchImages('insects', insectPage);
      insectPage++;
    }

    span.onclick = function() {
      modal.style.display = "none";
    }

    window.onclick = function(event) {
      if (event.target == modal) {
        modal.style.display = "none";
      }
    }

    document.getElementById('eraserButton').addEventListener('click', function() {
        isEraserActive = !isEraserActive; // Toggle eraser mode
        if (isEraserActive) {
            currentColor = '#FFFFFF'; // Set color to white for eraser
            this.classList.add('pressed'); // Add pressed state
        } else {
            currentColor = '#000000'; // Set color back to black when not in eraser mode
            this.classList.remove('pressed'); // Remove pressed state
        }
    });

    window.addEventListener('resize', function() {
        // Set up the canvas size
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight * 0.8; // Adjusted for control buttons height

        // Redraw the background image
        drawBackgroundImage();
    });
</script>
</body>
</html>
