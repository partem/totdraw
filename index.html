<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>TotDraw</title>
<style>
    body, html { margin: 0; padding: 0; overflow: hidden; }
    canvas { width: 100%; height: 80%; display: block; }
    #controls { 
        width: 100%; 
        height: 20%; 
        text-align: center; 
    }
    .control-button { 
        font-size: 30px;  
        padding: 10px;
        margin: 10px;
        cursor: pointer;
    }
    .hidden {
        display: none;
    }
</style>
</head>
<body>
<canvas id="drawingCanvas"></canvas>
<div id="controls">
    <button id="clearButton" class="control-button">üóëÔ∏è Clear</button>
    <input type="file" id="uploadButton" class="hidden" accept="image/*">
    <label for="uploadButton" class="control-button upload-button">üñºÔ∏è Upload</label>
    <input type="color" id="colorPicker" class="control-button">
</div>
<script>
    document.addEventListener('dblclick', function(event) {
        event.preventDefault();
    });
    const canvas = document.getElementById('drawingCanvas');
    const ctx = canvas.getContext('2d');
    let backgroundImage = null;
    let currentColor = '#000000'; // Default color

    // Set up the canvas size
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight * 0.8; // Adjusted for control buttons height

    let isDrawing = false;

    function startDrawing(e) {
        if (e.touches[0].touchType === 'stylus') {
            // Handle Apple Pencil touch
        } else {
            // Handle finger touch
        }
        isDrawing = true;
        draw(e);
        e.preventDefault(); // Prevent default behavior
    }

    function draw(e) {
        if (!isDrawing) return;
        ctx.lineWidth = 5; // Line width
        ctx.lineCap = 'round'; // Line style
        ctx.strokeStyle = currentColor; // Use the selected color

        const x = e.clientX || e.touches[0].clientX;
        const y = e.clientY || e.touches[0].clientY - canvas.offsetTop;

        ctx.lineTo(x, y); // Draw line
        ctx.stroke();
        ctx.beginPath(); // Begin new path
        ctx.moveTo(x, y);
    }

    function stopDrawing() {
        isDrawing = false;
        ctx.beginPath(); // Begin a new path to start a new line
    }

    // Clear the canvas and background
    function clearCanvas() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        backgroundImage = null; // Clear the reference to the background image
    }

    // Upload and draw background image
    function uploadAndDrawBackground(e) {
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(evt) {
                const img = new Image();
                img.onload = function() {
                    backgroundImage = img;
                    drawBackgroundImage(); // Use the drawBackgroundImage function
                }
                img.src = evt.target.result;
            };
            reader.readAsDataURL(file);
        }
    }

    function drawBackgroundImage() {
        if (backgroundImage) {
            const ratio = Math.min(canvas.width / backgroundImage.width, canvas.height / backgroundImage.height);
            const newWidth = backgroundImage.width * ratio;
            const newHeight = backgroundImage.height * ratio;
            const offsetX = (canvas.width - newWidth) / 2;
            const offsetY = (canvas.height - newHeight) / 2;
            ctx.drawImage(backgroundImage, offsetX, offsetY, newWidth, newHeight);
        }
    }

    // Event listeners for touch and mouse
    canvas.addEventListener('touchstart', startDrawing);
    canvas.addEventListener('touchmove', draw);
    canvas.addEventListener('touchend', stopDrawing);
    canvas.addEventListener('touchcancel', stopDrawing);
    canvas.addEventListener('mousedown', startDrawing);
    canvas.addEventListener('mousemove', draw);
    canvas.addEventListener('mouseup', stopDrawing);
    canvas.addEventListener('mouseleave', stopDrawing);

    // Event listener for the clear button
    document.getElementById('clearButton').addEventListener('click', clearCanvas);

    // Event listener for the upload button
    document.getElementById('uploadButton').addEventListener('change', uploadAndDrawBackground);

    // Color picker event listener
    document.getElementById('colorPicker').addEventListener('change', function(e) {
        currentColor = e.target.value;
    });

    // Prevent default scrolling on touch events
    document.addEventListener('touchmove', function(e) {
        e.preventDefault();
    }, { passive: false });
</script>
</body>
</html>
